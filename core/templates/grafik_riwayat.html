{% extends 'base.html' %}

{% block title %}Grafik Riwayat Pengukuran - Sistem Diagnosis Stunting{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 70vh;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Grafik Riwayat Pengukuran Z-Score</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard_pasien' %}">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Grafik Pertumbuhan</li>
            </ol>
        </nav>
        
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Grafik Pertumbuhan Z-Score</h5>
                    <div>
                        <a href="{% url 'input_pengukuran' %}" class="btn btn-info"><i class="fas fa-edit"></i> Kembali ke Form Input</a>
                        <a href="{% url 'input_pengukuran' %}" class="btn btn-primary btn-sm">Input Pengukuran Baru</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="zScoreChart"></canvas>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Keterangan Z-Score WHO:</strong><br>
                        <span style="color: green;">Z > -2:</span> Normal<br>
                        <span style="color: orange;">-3 &lt; Z &le; -2:</span> Risiko Stunting<br>
                        <span style="color: red;">Z &le; -3:</span> Stunting
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Data from backend
    const dataBBU = {{ data_bb_u|safe }};
    const dataTBU = {{ data_tb_u|safe }};
    
    // Extract dates and scores
    const dates = dataBBU.map(item => item.tgl);
    const bbuScores = dataBBU.map(item => item.score);
    const tbuScores = dataTBU.map(item => item.score);
    
    // Create chart
    const ctx = document.getElementById('zScoreChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Z-Score BB/U',
                    data: bbuScores,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    pointRadius: 5
                },
                {
                    label: 'Z-Score TB/U',
                    data: tbuScores,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    pointRadius: 5
                },
                // WHO Standard Lines
                {
                    label: 'Batas Normal (Z = +2)',
                    data: Array(dates.length).fill(2),
                    borderColor: 'green',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    yAxisID: 'y'
                },
                {
                    label: 'Batas Normal (Z = 0)',
                    data: Array(dates.length).fill(0),
                    borderColor: 'orange',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    yAxisID: 'y'
                },
                {
                    label: 'Batas Stunting (Z = -2)',
                    data: Array(dates.length).fill(-2),
                    borderColor: 'red',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: -4,
                    max: 4,
                    title: {
                        display: true,
                        text: 'Z-Score'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tanggal Pengukuran'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Grafik Pertumbuhan Z-Score'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
</script>
{% endblock %}